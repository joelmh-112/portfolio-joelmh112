---
import FormGroup from "@/components/ui/FormGroup.astro";
import Input from "@/components/ui/Input.astro";
import Button from "@/components/ui/Button.astro";
import { API_URL } from "astro:env/client";
import Layout from "@/layouts/Layout.astro";

const { email } = Astro.params;
const decodedEmail = decodeURIComponent(email);
---
<Layout title="Verifica tu código">
  <div class="flex items-center justify-center">
    <form id="verify-code-form" class="bg-gray-900 bg-opacity-80 p-8 rounded-xl shadow-lg flex flex-col gap-6 w-full max-w-sm border border-primary border-opacity-30">
      <h1 class="text-3xl font-oswald text-primary text-center mb-2">Introduce el código</h1>
      <FormGroup label="Email" id="email">
        <Input id="email" name="email" type="email" placeholder="tu@email.com" value={decodedEmail} required disabled/>
      </FormGroup>
      <FormGroup label="Código" id="code">
        <Input id="code" name="code" type="text" placeholder="Código recibido" required />
      </FormGroup>
      <Button type="submit" className="w-full mt-2">Iniciar sesión</Button>
    </form>
    <script define:vars={{decodedEmail,API_URL}}>
        
      // Prellenar el email si viene por query param
      const form = document.getElementById('verify-code-form');
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const code = form.elements['code'].value.trim();
        try {
          const res = await fetch('/brain/api/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: decodedEmail, code })
          });
          console.log("Login response:", res.body);
          if (res.ok) {
            const data = await res.json();
            // Si quieres guardar el usuario en localStorage:
            localStorage.setItem('user', JSON.stringify(data.user));
            window.location.href = '/brain/dashboard';
          } else {
            alert('Código incorrecto o expirado.');
          }
        } catch (err) {
          console.error(err);
          alert('Error de red.');
        }
      });
    </script>
  </div>
</L>
